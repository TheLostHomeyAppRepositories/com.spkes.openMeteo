<link href="https://63c568c5e1c0180b8a2acafe.connect.athom.com/manager/webserver/assets/css/homey.css"
      rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../../../assets/css/autoComplete.css"/>
<link rel="stylesheet" type="text/css" href="../../../assets/css/setup.css"/>

<div class="hy-view __private__open_meteo-setup__view" data-id="setup" data-template-id="setup"
     id="684836237846456.454564564561236">

    <div class="__private__open_meteo-setup">
        <form id="setup-form" class="__private__open_meteo-setup__form homey-form" action="/" method="post">
            <div class="__private__open_meteo-setup__center">
                <h1 id="setup-title" data-i18n="pair.setup.title" class="homey-title homey-text-align-center">Please
                    enter your location</h1>

                <div class="homey-form-group">
                    <label class="homey-form-label autocomplete" data-i18n="pair.setup.location.label" for="location">Location</label>
                    <input class="homey-form-input" data-i18n="pair.setup.location.placeholder" id="location"
                           name="location" type="text" value=""
                           placeholder="Hamburg">
                    <div class="selectedResult hidden" id="selectedResult">
                        <div class="selectedResultLabel" data-i18n="pair.setup.selectedLocation">
                            Selected Location
                        </div>
                        <div class="selectedResultItem" id="selectedResultItem">

                        </div>
                    </div>
                </div>


                <div class="homey-form-group">
                    <label class="homey-form-label" for="select-tempUnit" data-i18n="pair.setup.tempUnit.label">Temperature
                        Unit</label>
                    <select class="homey-form-select" name="select-tempUnit" id="select-tempUnit">
                        <option data-i18n="pair.setup.tempUnit.celsius" selected value="celsius">Celsius &#8451;
                        </option>
                        <option data-i18n="pair.setup.tempUnit.fahrenheit" value="fahrenheit">Fahrenheit &#8457;
                        </option>
                    </select>
                </div>

                <div class="homey-form-group">
                    <label data-i18n="pair.setup.windspeed_unit.label" class="homey-form-label"
                           for="select-windspeed_unit">Windspeed Unit</label>
                    <select class="homey-form-select" name="select-windspeed_unit" id="select-windspeed_unit">
                        <option selected value="kmh">Km/h</option>
                        <option value="ms">m/s</option>
                        <option value="mph">Mph</option>
                        <option value="kn">Knots</option>
                    </select>
                </div>

                <div class="homey-form-group">
                    <label data-i18n="pair.setup.timezone.label" class="homey-form-label"
                           for="select-timezone">Timezone</label>
                    <select class="homey-form-select" name="select-timezone" id="select-timezone">
                        <option value="America/Anchorage">America/Anchorage</option>
                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                        <option value="America/Denver">America/Denver</option>
                        <option value="America/Chicago">America/Chicago</option>
                        <option value="America/New_York">America/New_York</option>
                        <option value="America/Sao_Paulo">America/Sao_Paulo</option>
                        <option value="GMT">GMT+0</option>
                        <option data-i18n="pair.setup.timezone.auto" selected value="auto">Automatically detect time
                            zone
                        </option>
                        <option value="Europe/London">Europe/London</option>
                        <option value="Europe/Berlin">Europe/Berlin</option>
                        <option value="Europe/Moscow">Europe/Moscow</option>
                        <option value="Africa/Cairo">Africa/Cairo</option>
                        <option value="Asia/Bangkok">Asia/Bangkok</option>
                        <option value="Asia/Singapore">Asia/Singapore</option>
                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                        <option value="Australia/Sydney">Australia/Sydney</option>
                        <option value="Pacific/Auckland">Pacific/Auckland</option>
                    </select>
                </div>

                <div class="homey-form-group">
                    <label data-i18n="pair.setup.precipitation_unit.label" class="homey-form-label"
                           for="select-precipitation_unit">Precipitation Unit</label>
                    <select class="homey-form-select" name="select-precipitation_unit" id="select-precipitation_unit">
                        <option data-i18n="pair.setup.precipitation_unit.mm" selected value="mm">Millimeter</option>
                        <option data-i18n="pair.setup.precipitation_unit.inch" value="inch">Inch</option>
                    </select>
                </div>

            </div>

            <div class="__private__open_meteo-setup__information">
                <a href="https://open-meteo.com/" target="_blank"
                   data-i18n="pair.setup.open-meteo"
                   onclick="Homey.popup('https://open-meteo.com/')">
                    Weather data by Open-Meteo.com</a>
            </div>

            <div class="__private__open_meteo-setup__footer">
                <button tabindex="0" id="setup-next"
                        data-i18n="pair.setup.next"
                        class="homey-button-primary-shadow-full __private__open_meteo-setup__button"
                        type="submit">
                    Next
                </button>
            </div>
        </form>
    </div>

    <script src="../../../assets/js/autoComplete.min.js"></script>
    <script type="text/javascript">
        (function () {
            const $tmpl = document.getElementById('684836237846456.454564564561236');
            const $form = $tmpl.querySelector('#setup-form');
            let placeHolder = "Hamburg";
            let locationObject;
            let working = false;
            autoCompleteHandler();

            placeHolder = Homey.__('pair.setup.location.placeholder');
            // Hide default title bar
            Homey.setTitle(null);

            $form.addEventListener('submit', function (event) {
                event.preventDefault();
                if (working) return;
                working = true;
                Homey.showLoadingOverlay(Homey.__('pair.setup.loading'));
                console.log(locationObject)
                Homey.emit('setup', locationObject,
                    function (error, valid) {
                        if (error) {
                            Homey.error(error);
                        } else if (!valid) {
                            Homey.error(Homey.__('pair.setup.failed'));
                        } else if (valid) {
                            Homey.nextView();
                        }
                        working = false;
                        Homey.hideLoadingOverlay();
                    }
                );
                return false;
            });

            function autoCompleteHandler() {
                const autoCompleteJS = new autoComplete({
                    selector: "#location",
                    placeHolder: placeHolder,
                    data: {
                        src: async (query) => {
                            try {
                                const source = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&language=de`);
                                const data = await source.json();
                                console.log(data)
                                return data.results ?? [];
                            } catch (error) {
                                return error;
                            }
                        },
                        keys: ["name"],
                    },
                    resultsList: {
                        element: (list, data) => {
                            if (!data.results.length || data.results.length === 0) {
                                const message = document.createElement("div");
                                message.classList.add("noResult");
                                message.innerHTML = `<span>Found no results for "${data.query}"</span>`;
                                list.prepend(message);
                            }
                        },
                        noResults: true,
                        maxResults: 25
                    },
                    resultItem: {
                        element: (item, data) => {
                            let reg = new RegExp("(" + autoCompleteJS.feedback.query + ")")
                            let split = data.value.name.split(reg);
                            if (split.length > 1)
                                split[1] = "<mark>" + split[1] + "</mark>";

                            item.innerHTML = split.join("");
                            const img = document.createElement("img");
                            img.classList.add("search-icon");
                            img.src = `https://hatscripts.github.io/circle-flags/flags/${data.value.country_code.toLowerCase()}.svg`;
                            img.title = data.value.country;
                            item.prepend(img)

                            const description = document.createElement("div");
                            description.classList.add("description");
                            description.classList.add("icon-padding");
                            let admin = data.value.admin1 ?? data.value.admin2 ?? data.value.admin3 ?? undefined;
                            description.innerHTML = admin ? admin + " - " + data.value.country : data.value.country
                            item.append(description)
                        },
                        highlight: false,
                    },
                    events: {
                        input: {
                            keydown: (event) => {
                                if (event.target.classList.contains("complete"))
                                    event.target.classList.remove("complete")
                                let selectedResult = document.getElementById('selectedResult')
                                if (!selectedResult.classList.contains("hidden"))
                                    selectedResult.classList.add("hidden")
                                locationObject = undefined;
                            }
                        }
                    }
                });

                autoCompleteJS.input.addEventListener("selection", function (event) {
                    const feedback = event.detail;
                    //Setting the selection to the value of the input.
                    autoCompleteJS.input.value = feedback.selection.value.name;
                    if (!autoCompleteJS.input.classList.contains("complete"))
                        autoCompleteJS.input.classList.add("complete")
                    //Set the selection object to variable for later use
                    locationObject = feedback.selection.value;

                    //Create object for selectedResultItem
                    let selectedImg = document.createElement("img");
                    selectedImg.classList.add("search-icon");
                    selectedImg.src = `https://hatscripts.github.io/circle-flags/flags/${locationObject.country_code.toLowerCase()}.svg`;
                    selectedImg.title = locationObject.name;

                    let selectedText = document.createElement("div");
                    selectedText.classList.add("selectedText");
                    selectedText.innerText = locationObject.name;

                    let description = document.createElement("div");
                    description.classList.add("description");
                    let admin = locationObject.admin1 ?? locationObject.admin2 ?? locationObject.admin3 ?? undefined;
                    description.innerHTML = admin ? admin + " - " + locationObject.country : locationObject.country
                    selectedText.appendChild(description);

                    let selectedResultItem = document.getElementById('selectedResultItem')
                    selectedResultItem.innerHTML = ""
                    selectedResultItem.appendChild(selectedImg);
                    selectedResultItem.appendChild(selectedText);

                    let selectedResult = document.getElementById('selectedResult')
                    if (selectedResult.classList.contains("hidden"))
                        selectedResult.classList.remove("hidden")
                });
            }
        })();
    </script>
</div>
